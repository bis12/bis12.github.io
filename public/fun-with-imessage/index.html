<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width initial-scale=1" />

		<title>Fun with iMessage</title>
		<meta name="description" content="">

		<link rel="icon" href="/favicon.ico">
		<link href="/main.css" rel="stylesheet" type="text/css" media="all">
	</head>

	<body>
		<div class="page-container">
			<header class="page-header">
				<h1><a href="/">imbstack</a></h1>
				<div class="link-box">
					<a href="https://github.com/imbstack">github</a>
					<a href="https://twitter.com/imbstack">twitter</a>
				</div>
			</header>
			<nav class="page-nav">
				<input type="checkbox" id="show-nav-controller"/>
				<hr class="left"/>
				<label for="show-nav-controller"><h5>Read More</h5></label>
				<hr class="right" />
				<ul>
					
					
					<li>May 3, 2020 <a href="https://imbstack.com/debugging-docker-connection-resets/">Debugging Docker Connection Reset by Peer</a></li>
					
					<li>Apr 21, 2017 <a href="https://imbstack.com/tc-1-0/">The Future of Taskcluster</a></li>
					
					<li>Mar 15, 2017 <a href="https://imbstack.com/what-and-why-is-taskcluster/">What and Why is Taskcluster</a></li>
					
					<li>Sep 9, 2016 <a href="https://imbstack.com/taskcluster-notify/">Announcing Taskcluster Notifications</a></li>
					
					<li>Nov 14, 2015 <a href="https://imbstack.com/fun-with-imessage/">Fun with iMessage</a></li>
					
					<li>Oct 3, 2015 <a href="https://imbstack.com/attacking-the-monolith/">Attacking the Monolith</a></li>
					
				</ul>
			</nav>

			<main class="page-content">
				
<h1 class="title">
  Fun with iMessage
</h1>
<p class="subtitle"><strong>2015-11-14</strong></p>
<p>A friend of mine in a group chat was wondering how long people would go between talking or who talked the most often. I became curious and after some quick <a href="http://apple.stackexchange.com/a/80025">stackoverflowing</a> I found that you already have all of the data you need locally if you use Messages on <span class="nowrap">OS X</span>. As of today on <span class="nowrap">El Capitan</span>, you can easily hop into the database with <span class="code">sqlite3 ~/Library/Messages/chat.db</span>.</p>
<div class="note">
Note: This only goes back as far as you used Messages on OS X. To get all of your messages from your phone, back it up to your computer and find the sqlite database in <span class="code">~/Library/Application\ Support/MobileSync/Backup/</span> <a href="http://www.wired.com/2013/11/backup-sms-iphone/">(Thanks, Wired!)</a>. You'll find that there are just a mess of files with no names to help you; picking a string from your OS X copy of the Messages db and grepping for it in the backup seems to work.
</div>
<p>The only tables I ended up caring about to answer this question were <span class="code">message</span> and <span class="code">handle</span>. I'll talk a bit more about how to generate this in a moment, but for now, we can look at <a href="https://imbstack.com/fun-with-imessage/#imessage-fig1">Figure 1</a> and see what the final product is.</p>
<div id="imessage-fig1" class="figure">
    <div></div>
    <span class="caption pure-hidden-xs">Figure 1. Messages per day by participant.</span>
    <span class="caption pure-visible-xs">Figure 1</span>
</div>
<p>From <a href="https://imbstack.com/fun-with-imessage/#imessage-fig1">Figure 1</a> we can extrapolate into the future and see that Pat will need to spend every single waking second sending texts to this group and I'm probably dead, can someone check on me?</p>
<div class="note">
    Note: It's <em>always</em> ok to extrapolate from two data points.
</div>
<p>There aren't that many steps to getting that plot put together. The first step will be to find which &quot;room&quot; your chats have been taking place in. As far as I can tell, each message is connected to a room via the <span class="code">cache_roomnames</span> column. Your chat's roomname will be something along the lines of <span class="code">chatNNNNNNNNNNNNNNNNNN</span>, where the <span class="code">N</span>'s are obviously numbers. I found the room I wanted by getting the last messages I received and then matching up a message that was from the room to its roomname.</p>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT</span><span> cache_roomnames, </span><span style="color:#b48ead;">text
</span><span style="color:#b48ead;">FROM</span><span> message
</span><span style="color:#b48ead;">WHERE</span><span> cache_roomnames != &#39;&#39;
</span><span style="color:#b48ead;">ORDER BY date DESC LIMIT </span><span style="color:#d08770;">10</span><span>;
</span></code></pre>
<p>Once you have your desired room, you can get every message in it that your heart desires. I found that pulling out just a few key columns got me what I wanted, and joining the <span class="code">handle_id</span> column to the <span class="code">handle</span> table gets you a phone number for each participant.</p>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT </span><span style="color:#d08770;">M</span><span>.</span><span style="color:#d08770;">handle_id</span><span>,
</span><span>       </span><span style="color:#d08770;">H</span><span>.</span><span style="color:#d08770;">id</span><span>,
</span><span>       strftime(&#39;</span><span style="color:#a3be8c;">%s</span><span>&#39;, </span><span style="color:#d08770;">M</span><span>.</span><span style="color:#d08770;">date </span><span>+ strftime(&#39;</span><span style="color:#a3be8c;">%s</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">2001-01-01 00:00:00</span><span>&#39;), &#39;</span><span style="color:#a3be8c;">unixepoch</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">localtime</span><span>&#39;),
</span><span>       </span><span style="color:#d08770;">M</span><span>.</span><span style="color:#d08770;">text
</span><span style="color:#b48ead;">FROM</span><span> message AS M
</span><span style="color:#b48ead;">LEFT OUTER JOIN</span><span> handle AS H ON </span><span style="color:#d08770;">M</span><span>.</span><span style="color:#d08770;">handle_id </span><span>= </span><span style="color:#d08770;">H</span><span>.</span><span style="color:#d08770;">rowid
</span><span style="color:#b48ead;">WHERE </span><span style="color:#d08770;">M</span><span>.</span><span style="color:#d08770;">cache_roomnames </span><span>= &#39;</span><span style="color:#a3be8c;">chatNNNNNNNNNNNNNNNNNN</span><span>&#39;
</span><span style="color:#b48ead;">ORDER BY date</span><span>;
</span></code></pre>
<p>That '2001-01-01 00:00:00' is necessary because iMessage starts counting time from 2001 for some reason I'll never understand. What you want to do at this point is up to you, but I output it as a csv and go to work from there in Python. One note to keep in mind, messages will occasionally have newlines in them, so you may want to define a newline of your own in your csv output. This will make it harder to read normally, but fixes that issue. I'm almost certain there's a better way of solving it, and if you know one, let me know!</p>
<p>From there it's just some simple scripting to make a histogram of posts per user and plot it however you like. I have a manual <code>phone-number -&gt; human-name</code> dictionary in my code. I'm not sure if there's a way to automate this with wherever Contacts stores its data, but perhaps that's a post for another day.</p>
<p>This got me curious, what does my history look like across <em>everyone</em> I've talked to? Well, here you go:</p>
<div id="imessage-fig2" class="figure">
    <div></div>
    <span class="caption pure-hidden-xs">Figure 2. Messages per week per person.</span>
    <span class="caption pure-visible-xs">Figure 2</span>
</div>
<p>In <a href="https://imbstack.com/fun-with-imessage/#imessage-fig2">Figure 2</a> I plot the messages per week from anyone who sent me over 150 messages in a week at least once since I've had the phone (arbitrary threshold to keep plot clean). With the exception of Person E and Person F, the top texter during any period of time was the person I was dating at that time. I've not revealed identities here to protect the innocent.</p>
<p>Over the course of a normal week, when are people texting me? We can pretty much steal Github's punchcard visualization and reproduce it <a href="https://imbstack.com/fun-with-imessage/#imessage-fig3">Figure 3</a> with texts instead of commits.</p>
<div id="imessage-fig3" class="figure">
    <div></div>
    <span class="caption pure-hidden-xs">Figure 3. Times when texts are happening.</span>
    <span class="caption pure-visible-xs">Figure 3</span>
</div>
<script type="text/javascript">
var punchcard = function(args) {
    var el = d3.select(args.bindto);
    var margin = {top: 30, right: 30, bottom: 20, left: 50};
    var width = el[0][0].offsetWidth - margin.left - margin.right;
    var height = width * (1/1.6) - margin.top - margin.bottom;

    var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    var svg = el.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var x = d3.scale.linear().domain([0, 24]).range([0, width]);
    var y = d3.scale.linear().domain([0, 6]).range([0, height]);

    xAxis = d3.svg.axis().ticks(6).scale(x).orient('top').tickFormat( function(d) { return d + ':00' });
    yAxis = d3.svg.axis().ticks(7).scale(y).orient('left').tickFormat( function(d, i) { return days[i]; });

    svg.append('g').attr("class", "x axis").call(xAxis).selectAll('text').attr("dy", "-.6em");
    svg.append('g').attr("class", "y axis").call(yAxis);


    for (var i in days) {
        svg.append('g')
           .attr("transform", "translate(0," + y(i) + ")")
           .attr("class", "x axis")
           .call(d3.svg.axis().scale(x).ticks(24).tickFormat(''));
    }

    d3.text(args.data, function(error, text) {
        if (error) return console.warn(error);
        var data = d3.csv.parseRows(text)

        svg.append('g')
           .selectAll('g')
           .data(data)
           .enter()
           .append('g')
           .selectAll('g')
           .data( function(d,i,j) { return d; } )
           .enter()
           .append('circle')
           .attr('fill', '#333')
           .attr('class','hover')
           .attr('title', function(d,i,j) { return d })
           .attr('cy', function(d,i,j) { return y(j) })
           .attr('cx', function(d,i,j) { return x(i + 1) })
           .attr('r', function(d,i,j) { return +d * 0.015 });
    });
}

document.addEventListener("DOMContentLoaded", function() {

    // Plot of people in chat room
    c3.generate({
        bindto: '#imessage-fig1>div',
        data: {
            url: '/data/talkers.json',
            type: 'spline',
            mimeType: 'json'
        },
        axis: {
            x: {
                label: 'Days since Brian was in chat'
            },
            y: {
                label: 'Messages per day',
            }
        },
        grid: {
            x: {
                lines: [
                    {value: 4, text: 'Some holiday with candy'},
                    {value: 11, text: 'Talking about food?'},
                    {value: 15, text: 'Someone gets a new cable box?'}
                ]
            }
        }
    });

    // Plot of everyone I've talked to
    c3.generate({
        bindto: '#imessage-fig2>div',
        data: {
            url: '/data/all_talkers.json',
            type: 'spline',
            mimeType: 'json'
        },
        axis: {
            x: {
                label: 'Weeks since Brian had iPhone'
            },
            y: {
                label: 'Messages per week',
            }
        }
    });

    // Punchcard for text times
    punchcard({
        bindto: '#imessage-fig3>div',
        data: '/data/punchcard.csv'
    });
});
</script>


			</main>
			</section>
			<script type='text/javascript' src='/js/c3.min.js'></script>
			<script type='text/javascript' src='/js/d3.min.js'></script>
			<script type='text/javascript' src='/js/main.js'></script>
	</body>

</html>

